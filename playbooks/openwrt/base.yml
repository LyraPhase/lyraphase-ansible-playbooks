---
# This playbook bootstraps an OpenWRT LEDE router with base settings

- name: OpenWRT Base
  hosts: openwrt
  user: root
  gather_facts: "{{ not (ansible_bootstrap | default(false)) }}"
  vars_files:
    - "vars/openwrt-base.yml"

  roles:
    - openwrt-base
#    - openwrt-logrotate
    - role: imp1sh.ansible_managemynetwork.ansible_packages
      when: not (ansible_bootstrap | default(false))
      tags:
        - opkg_packages
        - packages
        - install_packages
  tasks:
    - name: Get original banner contents
      ansible.builtin.slurp:
        src: "/etc/banner"
      register: openwrt_banner
      tags:
        - openwrt_banner
    - name: Install SSH banner file
      ansible.builtin.template:
        src: templates/lyra-vega-banner.j2
        dest: "{{ openwrt_dropbear_bannerfile | default('/etc/config/lyra-vega-banner') }}"
        owner: root
        group: root
        mode: "0644"
      register: openwrt_custom_banner
      tags:
        - openwrt_banner
