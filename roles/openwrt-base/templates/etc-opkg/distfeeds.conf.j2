{% if ansible_distribution is defined and
      ansible_distribution == 'LEDE' -%}
{%   set dist_url_hostname = 'downloads.lede-project.org' -%}
{% elif ansible_distribution is defined and
      ansible_distribution == 'OpenWrt' -%}
{%   set dist_url_hostname = 'downloads.openwrt.org' -%}
{% else -%}
{%   set dist_url_hostname = 'downloads.openwrt.org' -%}
{% endif -%}
{% if ansible_distribution_major_version is defined and
      ansible_distribution_major_version == 'snapshot' or
      not ansible_distribution_major_version is defined -%}
{%   set dist_vers = 'snapshots' -%}
{% elif ansible_distribution_major_version is defined -%}
{%   set dist_vers = ansible_distribution_version -%}
{% endif -%}
{% if os_release_data is defined and 'distrib_arch' in os_release_data -%}
{%   set dist_arch = os_release_data.distrib_arch -%}
{% else -%}
{#%  Best guess ... ¯\_(ツ)_/¯ %#}
# Warning: Cound not detect DISTRIB_ARCH from /etc/openwrt_release
#          Using best guess according to ansible_architecture
#          Ensure /etc/openwrt_release is configured properly if this is wrong!
{%   set arch_specific_packages = {
       "i386": "i386_pentium4",
       "i686": "i386_pentium-mmx",
       "x86_64": "x86_64",
       "aarch64": "aarch64_generic",
       "aarch64_be": "armeb_xscale",
       "arm": "arm_cortex-a7_neon-vfpv4",
       "armv7l": "arm_cortex-a15_neon-vfpv4",
       "riscv64": "riscv64_riscv64",
       "ppc": "powerpc_464fp",
       "ppc64": "powerpc64_e5500",
       "mips": "mips_24kc",
       "mipsel": "mipsel_mips32",
       "mips64": "mips64_mips64r2",
       "mips64el": "mips64el_mips64r2",
       "loongarch64": "loongarch64_generic"
     }
-%}
{%   set dist_arch = arch_specific_packages[ansible_architecture] -%}
{% endif -%}
{% if os_release_data is defined and 'distrib_target' in os_release_data -%}
{%   set dist_target = os_release_data.distrib_target -%}
{% else -%}
{#%  Best guess ... ¯\_(ツ)_/¯ %#}
# Warning: Cound not detect DISTRIB_TARGET from /etc/openwrt_release
#          Using best guess according to ansible_architecture
#          Ensure /etc/openwrt_release is configured properly if this is wrong!
{%   set arch_target = {
       "i386": "x86/generic",
       "i686": "x86/legacy",
       "x86_64": "x86/64",
       "aarch64": "rockchip/armv8",
       "aarch64_be": "ixp4xx/generic",
       "arm": "ipq40xx/generic",
       "armv7l": "ipq806x/generic",
       "riscv64": "starfive/generic",
       "ppc": "apm821xx/nand",
       "ppc64": "qoriq/generic",
       "mips": "ramips/mt7621",
       "mipsel": "bcm47xx/generic",
       "mips64": "malta/be64",
       "mips64el": "malta/le64",
       "loongarch64": "loongarch64/generic"
     }
-%}
{%   set dist_target = arch_target[ansible_architecture] -%}
{% endif -%}
{% if ansible_distribution is defined and
      ansible_distribution == 'OpenWrt' and
      ansible_distribution_version is defined and
      ansible_distribution_version != 'snapshot' -%}
{%     set openwrt_profiles_url = "https://" + dist_url_hostname + "/releases/" + dist_vers + "/targets/" + dist_target + "/profiles.json" -%}
{%     set openwrt_release_metadata = lookup('ansible.builtin.url', openwrt_profiles_url, split_lines=False) | from_json -%}
{%     set dist_kernel_rev = openwrt_release_metadata['linux_kernel']['release'] -%}
{%     set dist_kernel_vermagic = openwrt_release_metadata['linux_kernel']['vermagic'] -%}
{%   endif -%}
{% if ansible_distribution is defined and
      ansible_distribution == 'LEDE' -%}
src/gz reboot_core http://{{ dist_url_hostname }}/releases/{{ dist_vers }}/targets/mvebu/generic/packages
#src/gz reboot_core http://{{ dist_url_hostname }}/releases/{{ dist_vers }}/targets/arm_cortex-a9_vfpv3/generic/packages
src/gz reboot_base http://{{ dist_url_hostname }}/releases/{{ dist_vers }}/packages/arm_cortex-a9_vfpv3/base
src/gz reboot_luci http://{{ dist_url_hostname }}/releases/{{ dist_vers }}/packages/arm_cortex-a9_vfpv3/luci
src/gz reboot_packages http://{{ dist_url_hostname }}/releases/{{ dist_vers }}/packages/arm_cortex-a9_vfpv3/packages
src/gz reboot_routing http://{{ dist_url_hostname }}/releases/{{ dist_vers }}/packages/arm_cortex-a9_vfpv3/routing
src/gz reboot_telephony http://{{ dist_url_hostname }}/releases/{{ dist_vers }}/packages/arm_cortex-a9_vfpv3/telephony
{% else -%}
src/gz openwrt_core https://{{ dist_url_hostname }}/releases/{{ dist_vers }}/targets/{{ dist_target }}/packages
src/gz openwrt_base https://{{ dist_url_hostname }}/releases/{{ dist_vers }}/packages/{{ dist_arch }}/base
src/gz openwrt_kmods https://{{ dist_url_hostname }}/releases/{{ dist_vers }}/targets/{{ dist_target }}/kmods/{{ ansible_kernel }}-{{ dist_kernel_rev | default('1') }}-{{ dist_kernel_vermagic | default('') }}
src/gz openwrt_luci https://{{ dist_url_hostname }}/releases/{{ dist_vers }}/packages/{{ dist_arch }}/luci
src/gz openwrt_packages https://{{ dist_url_hostname }}/releases/{{ dist_vers }}/packages/{{ dist_arch }}/packages
src/gz openwrt_routing https://{{ dist_url_hostname }}/releases/{{ dist_vers }}/packages/{{ dist_arch }}/routing
src/gz openwrt_telephony https://{{ dist_url_hostname }}/releases/{{ dist_vers }}/packages/{{ dist_arch }}/telephony
{% endif -%}
